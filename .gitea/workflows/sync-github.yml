name: Sync github-release â†’ opcUaPlc

on:
  push:
    branches: [ github-release ]

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Gitea repo
      uses: actions/checkout@v4
      with:
        ref: github-release
        fetch-depth: 0

    - name: Exclude Gitea workflows + config
      run: |
        git rm -r --cached .gitea/workflows || true
        git rm -r --cached opcUaConfig/opcUaConfig.json || true
        git clean -fd .gitea/workflows || true
        git clean -fd opcUaConfig/ || true  # Cartella intera

    - name: Sync to GitHub
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
        GH_REPO_OPCUAPLC: ${{ secrets.GH_REPO_OPCUAPLC }}  # â† OK se cosÃ¬ lo chiami
      run: |
        git config --global user.name "Gitea Action"
        git config --global user.email "action@gitea.local"
        
        # âœ… FIX: --all PRIMA del remote
        git remote add github "https://x-access-token:${GH_TOKEN}@github.com/${GH_REPO_OPCUAPLC}.git"
        git fetch --all --prune --tags github  # â† Corretto!
        
        # Detect branch
        DEFAULT_BRANCH=$(git symbolic-ref -q refs/remotes/github/HEAD | sed 's@^refs/remotes/github/@@' || echo "main")
        echo "ðŸŽ¯ GitHub branch: $DEFAULT_BRANCH"
        
        # Pulizia + checkout forzato
        git clean -fdx
        git checkout --force -B sync-main github/$DEFAULT_BRANCH
        
        # Merge + push
        git merge github-release --no-ff -m "Auto-sync Gitea github-release -> $DEFAULT_BRANCH $(date)"
        git push github sync-main:$DEFAULT_BRANCH --force-with-lease
        
        echo "âœ… Completato!"
        git remote remove github
